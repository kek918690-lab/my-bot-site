<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0d0d0d; --card: #1a1a1a; --accent: #3498db; --green: #2ecc71; --red: #e74c3c; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; }
        
        .top-bar { background: var(--card); padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 100; }
        .s-item { font-size: 12px; color: #888; }
        .s-item b { color: #fff; font-size: 16px; display: block; }
        
        .hp-bar { grid-column: span 2; background: #222; height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        #hp-fill { height: 100%; width: 100%; background: var(--green); transition: 1s linear; }

        .page { display: none; padding: 15px; }
        .active { display: block; }

        .card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        
        /* –†–µ–¥–∫–æ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç–æ–≤ */
        .rarity-common { border-left: 4px solid #888; }
        .rarity-rare { border-left: 4px solid #3498db; }
        .rarity-epic { border-left: 4px solid #9b59b6; }
        .rarity-mythic { border-left: 4px solid #e74c3c; }
        .rarity-legendary { border-left: 4px solid #f1c40f; box-shadow: inset 0 0 10px rgba(241,196,15,0.2); }

        .stat-line { color: #2ecc71; font-size: 12px; }
        .enchant-line { color: #f39c12; font-size: 12px; font-style: italic; }

        .navbar { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; border-top: 1px solid #333; padding: 10px 0; }
        .nav-item { flex: 1; text-align: center; color: #555; font-size: 11px; cursor: pointer; }
        .active-nav { color: var(--accent); }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="s-item">üí∞ –ú–æ–Ω–µ—Ç—ã <b id="money">100</b></div>
        <div class="s-item">üì¶ –°–∫–ª–∞–¥ <b id="res_count">0</b></div>
        <div class="s-item">üß™ –ú–µ–¥. <b id="med_stock">0</b></div>
        <div class="s-item">‚ú® –ê—Ä—Ç. <b id="arts">0</b></div>
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div id="shield-stat" style="grid-column: span 2; text-align: center; font-size: 10px; margin-top: 5px; color: #e74c3c;">–£–Ø–ó–í–ò–ú</div>
    </div>

    <div id="page-main" class="page active">
        <div id="choice-screen">
            <h3>üè¢ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</h3>
            <button class="btn" onclick="startWork('med')">üè• –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è (–ú–µ–¥–∏—Ü–∏–Ω–∞)</button>
            <button class="btn" onclick="startWork('build')" style="margin-top:10px">üß± –ó–∞–≤–æ–¥ (–ö–∏—Ä–ø–∏—á–∏)</button>
            <button class="btn" onclick="startWork('food')" style="margin-top:10px">üçé –¢–µ–ø–ª–∏—Ü–∞ (–ï–¥–∞)</button>
        </div>
        <div id="work-ui" style="display:none; text-align: center;">
            <h2 id="ind-title">–û–±—ä–µ–∫—Ç</h2>
            <div style="font-size: 32px; font-weight: bold; margin: 20px 0; color: #3498db;" id="timer">--:--</div>
            <button class="btn" style="background:var(--green)" onclick="useMed()">üíâ –ó–∞—â–∏—Ç–∞ (100 –ú–µ–¥.)</button>
            <button class="btn" style="background:#222; border: 1px solid #444;" onclick="save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –û–±–ª–∞–∫–æ</button>
        </div>
    </div>

    <div id="page-forge" class="page">
        <h3>üî® –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –ö—É–∑–Ω–∏—Ü–∞</h3>
        <div class="card">
            <b>–ö–æ–≤–∫–∞ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è</b><br>
            <small style="color: #888;">–¶–µ–Ω–∞: 500üì¶ + 1‚ú®</small>
            <button class="btn" onclick="craftItem()">–ö–û–í–ê–¢–¨ –ü–†–ï–î–ú–ï–¢</button>
        </div>
        <div id="inventory-list"></div>
    </div>

    <nav class="navbar">
        <div class="nav-item active-nav" id="nav-main" onclick="showPage('main')">üè¢ –û–±—ä–µ–∫—Ç</div>
        <div class="nav-item" id="nav-forge" onclick="showPage('forge')">üî® –ö—É–∑–Ω–∏—Ü–∞</div>
    </nav>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        let s = { money: 100, res: 0, med: 0, arts: 0, hp: 100, shield: 0, type: '', timeLeft: 0, inv: [] };

        const rarities = [
            { n: '–û–±—ã—á–Ω—ã–π', c: 60, cls: 'rarity-common', m: 1 },
            { n: '–†–µ–¥–∫–∏–π', c: 25, cls: 'rarity-rare', m: 1.5 },
            { n: '–≠–ø–∏—á–µ—Å–∫–∏–π', c: 10, cls: 'rarity-epic', m: 2.2 },
            { n: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π', c: 4, cls: 'rarity-mythic', m: 3.5 },
            { n: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', c: 1, cls: 'rarity-legendary', m: 5 }
        ];

        const enchants = {
            w: ["üî• –í–æ—Å–ø–ª–∞–º–µ–Ω–µ–Ω–∏–µ", "‚ö° –°–∫–æ—Ä–æ—Å—Ç—å", "üéØ –ö—Ä–∏—Ç. —à–∞–Ω—Å", "üíÄ –ö—Ä–∏—Ç. —É—Ä–æ–Ω"],
            a: ["üíé –û—Ç—Ä–∞–∂–µ–Ω–∏–µ", "üåµ –®–∏–ø—ã", "üèÉ –£–≤–æ—Ä–æ—Ç", "üõ°Ô∏è –ó–∞—â–∏—Ç–∞"]
        };

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
            document.getElementById('nav-' + p).classList.add('active-nav');
        }

        function startWork(t) {
            s.type = t; 
            s.timeLeft = Math.floor(Math.random() * 300) + 300;
            document.getElementById('choice-screen').style.display = 'none';
            document.getElementById('work-ui').style.display = 'block';
            document.getElementById('ind-title').innerText = "üè¢ " + t.toUpperCase();
        }

        function craftItem() {
            if(s.res < 500 || s.arts < 1) {
                tg.showAlert("–ù—É–∂–Ω–æ 500 —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ 1 –∞—Ä—Ç–µ—Ñ–∞–∫—Ç!");
                return;
            }
            s.res -= 500; s.arts -= 1;

            let r = rarities[0]; let rd = Math.random() * 100; let acc = 0;
            for(let x of rarities) { acc += x.c; if(rd <= acc) { r = x; break; } }

            let q = 1 + (Math.floor(Math.random() * 10) + 1) / 100;
            let power = r.m * q;
            let isW = Math.random() > 0.5;
            
            let item = {
                id: Date.now(), 
                name: isW ? "–ë–æ–µ–≤–æ–π –ú–µ—á" : "–î–æ—Å–ø–µ—Ö",
                rar: r.n, cls: r.cls, qual: Math.round((q-1)*100),
                stats: isW ? [`–£—Ä–æ–Ω: ${Math.round(20*power)}`] : [`–•–ü: ${Math.round(150*power)}`],
                ench: []
            };

            let eCount = r.n === '–†–µ–¥–∫–∏–π' ? 1 : r.n === '–≠–ø–∏—á–µ—Å–∫–∏–π' ? 2 : r.n === '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π' ? 3 : r.n === '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' ? 4 : 0;
            let pool = [...enchants[isW ? 'w' : 'a']];
            for(let i=0; i<eCount; i++) {
                if(pool.length) {
                    let index = Math.floor(Math.random() * pool.length);
                    item.ench.push(pool.splice(index, 1)[0]);
                }
            }

            s.inv.push(item);
            updateInvUI();
            updateUI();
            tg.showAlert(`–í—ã–∫–æ–≤–∞–Ω ${item.rar} ${item.name}!`);
        }

        function updateInvUI() {
            let html = '';
            s.inv.forEach(i => {
                html += `<div class="card ${i.cls}"><b>${i.rar} ${i.name}</b> <small>(+${i.qual}% –∫–∞—á–µ—Å—Ç–≤–æ)</small><br>`;
                i.stats.forEach(st => html += `<div class="stat-line">‚óè ${st}</div>`);
                i.ench.forEach(en => html += `<div class="enchant-line">‚ú® ${en}</div>`);
                html += `</div>`;
            });
            document.getElementById('inventory-list').innerHTML = html || '<p style="text-align:center; color:#555;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
        }

        function useMed() {
            if(s.med >= 100) { 
                s.med -= 100; s.shield = 900; s.hp = 100; 
                tg.showAlert("–ó–∞—â–∏—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!"); 
            } else {
                tg.showAlert("–ù—É–∂–Ω–æ 100 –µ–¥. –º–µ–¥–∏—Ü–∏–Ω—ã!");
            }
            updateUI();
        }

        setInterval(() => {
            if(!s.type) return;
            
            s.timeLeft--;
            if(s.timeLeft <= 0) {
                s.timeLeft = Math.floor(Math.random() * 300) + 300;
                if(s.type === 'med') s.med += 15; else s.res += 15;
                s.money += 5;
                if(Math.random() < 0.15) s.arts++;
            }

            if(s.shield > 0) {
                s.shield--;
            } else {
                s.hp -= (1/60);
                if(s.hp < 0) s.hp = 0;
            }
            updateUI();
        }, 1000);

        function updateUI() {
            document.getElementById('money').innerText = Math.floor(s.money);
            document.getElementById('res_count').innerText = s.res;
            document.getElementById('med_stock').innerText = s.med;
            document.getElementById('arts').innerText = s.arts;
            document.getElementById('hp-fill').style.width = s.hp + '%';
            
            let m = Math.floor(s.timeLeft/60), sc = s.timeLeft%60;
            document.getElementById('timer').innerText = s.type ? `${m}:${sc < 10 ? '0' : ''}${sc}` : "--:--";
            
            let ss = document.getElementById('shield-stat');
            if(s.shield > 0) {
                ss.innerText = `–ó–ê–©–ò–¢–ê: ${Math.floor(s.shield/60)} –º–∏–Ω`;
                ss.style.color = "#3498db";
            } else {
                ss.innerText = "–£–Ø–ó–í–ò–ú (–•–ü –ü–ê–î–ê–ï–¢)";
                ss.style.color = "#e74c3c";
            }
        }

        function save() {
            tg.sendData(JSON.stringify({
                res: s.res, money: s.money, med: s.med, 
                arts: s.arts, hp: s.hp, shield: s.shield, inv: s.inv
            }));
        }

        updateUI();
        updateInvUI();
    </script>
</body>
</html>
