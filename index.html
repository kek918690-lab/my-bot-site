<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --bg: #09090b; --card: #18181b; --accent: #3b82f6; 
            --green: #10b981; --red: #ef4444; --text: #fafafa; --gold: #f59e0b; 
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 110px; user-select: none; }
        
        .top-bar { 
            background: rgba(24, 24, 27, 0.9); backdrop-filter: blur(12px);
            padding: 10px; display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 5px; border-bottom: 1px solid #27272a; position: sticky; top: 0; z-index: 100;
        }
        .res-item { text-align: center; background: rgba(255,255,255,0.03); padding: 5px; border-radius: 8px; }
        .res-item span { font-size: 8px; color: #a1a1aa; display: block; }
        .res-item b { color: var(--text); font-size: 11px; }

        .hp-section { grid-column: span 3; margin-top: 8px; position: relative; }
        .hp-bg { background: #27272a; height: 12px; border-radius: 6px; overflow: hidden; border: 1px solid #3f3f46; }
        #hp-fill { background: var(--green); height: 100%; width: 100%; transition: 0.5s; }
        #shield-info { position: absolute; width: 100%; text-align: center; top: 0; font-size: 9px; font-weight: bold; color: white; line-height: 12px; }

        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid #27272a; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: 700; cursor: pointer; margin-top: 8px; }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.3; filter: grayscale(1); }
        
        .navbar { position: fixed; bottom: 0; width: 100%; background: #09090b; display: flex; border-top: 1px solid #27272a; padding: 10px 0; z-index: 200; }
        .nav-item { flex: 1; text-align: center; color: #71717a; font-size: 10px; }
        .active-nav { color: var(--accent); font-weight: bold; }

        .log { font-size: 11px; color: #888; background: #000; padding: 10px; border-radius: 10px; height: 80px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="res-item"><span>üí∞ –ú–û–ù–ï–¢–´</span><b id="m-money">0</b></div>
        <div class="res-item"><span>üß± –ö–ò–†–ü–ò–ß</span><b id="m-res">0</b></div>
        <div class="res-item" onclick="healWorkers()"><span>üß™ –ú–ï–î–ò–¶–ò–ù–ê</span><b id="m-med">0</b></div>
        <div class="res-item"><span>üçé –ï–î–ê</span><b id="m-food">0</b></div>
        <div class="res-item"><span>‚ú® –ì–ï–†–û–ô</span><b id="m-art-p">0</b></div>
        <div class="res-item"><span>üìú –ö–£–ó–ù–Ø</span><b id="m-art-k">0</b></div>
        
        <div class="hp-section">
            <div class="hp-bg"><div id="hp-fill"></div></div>
            <div id="shield-info">HP –†–ê–ë–û–ß–ò–•: 100%</div>
        </div>
    </div>

    <div id="p-home" class="page active">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>–°–∏–ª–∞ –ì–µ—Ä–æ—è: <b id="p-power" style="font-size: 20px; color:var(--gold)">10</b></div>
                <button class="btn" style="width:auto; margin:0; background:var(--gold); color:#000; padding: 8px 12px;" onclick="upgradeHero()">–ê–ü (5‚ú®)</button>
            </div>
        </div>

        <div id="setup-view" class="card">
            <h3>üè¢ –í—ã–±–æ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</h3>
            <button class="btn" onclick="startWork('–ó–∞–≤–æ–¥')">üß± –ö–∏—Ä–ø–∏—á–Ω—ã–π –ó–∞–≤–æ–¥</button>
            <button class="btn" onclick="startWork('–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è')" style="background:var(--green)">üß™ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</button>
            <button class="btn" onclick="startWork('–¢–µ–ø–ª–∏—Ü–∞')" style="background:#f97316">üçé –¢–µ–ø–ª–∏—Ü–∞ –µ–¥—ã</button>
        </div>

        <div id="work-view" style="display:none;" class="card">
            <h3 id="work-title" style="text-align: center; margin:0; color:#a1a1aa">–†–ê–ë–û–¢–ê</h3>
            <div id="timer" style="font-size: 48px; text-align: center; font-weight: 900; color: var(--accent);">02:00</div>
            <p id="hp-warning" style="color:var(--red); text-align:center; display:none; font-weight:bold;">‚ö†Ô∏è –ù–£–ñ–ù–û –õ–ï–ß–ï–ù–ò–ï!</p>
        </div>
    </div>

    <div id="p-battle" class="page">
        <h3>‚öîÔ∏è –ë–æ–µ–≤–∞—è –ê—Ä–µ–Ω–∞</h3>
        <div class="card" style="text-align:center">
            <p>–í—Ä–∞–≥: <b style="color:var(--red)">–¢–µ–º–Ω—ã–π –†—ã—Ü–∞—Ä—å</b></p>
            <button class="btn" style="background:var(--red)" onclick="doBattle()">–í–°–¢–£–ü–ò–¢–¨ –í –ë–û–ô</button>
            <div id="battle-log" class="log"></div>
        </div>
    </div>

    <div id="p-forge" class="page">
        <h3>üî® –ö—É–∑–Ω–∏—Ü–∞</h3>
        <div class="card">
            <div id="forge-status" style="text-align:center; margin-bottom:10px">–ì–æ—Ç–æ–≤–∞</div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px">
                <button class="btn" id="btn-c1" onclick="craft(1)">x1</button>
                <button class="btn" id="btn-c3" onclick="craft(3)">x3</button>
                <button class="btn" id="btn-c5" onclick="craft(5)">x5</button>
            </div>
        </div>
        <div id="inv-list"></div>
    </div>

    <nav class="navbar">
        <div class="nav-item active-nav" onclick="showTab('home', this)">üè† –ë–∞–∑–∞</div>
        <div class="nav-item" onclick="showTab('battle', this)">‚öîÔ∏è –ë–æ–π</div>
        <div class="nav-item" onclick="showTab('forge', this)">üî® –ö—É–∑–Ω—è</div>
    </nav>

    <script>
        let tg = window.Telegram.WebApp;
        
        // –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–•
        let s = JSON.parse(localStorage.getItem('game_save')) || { 
            money: 100, res: 0, med: 0, food: 0, artP: 0, artK: 0, 
            power: 10, type: '', timeLeft: 120, forgeReady: 0, inv: [],
            hp: 100, shield: 0 
        };

        function save() {
            localStorage.setItem('game_save', JSON.stringify(s));
        }

        function showTab(name, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + name).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active-nav'));
            el.classList.add('active-nav');
        }

        function startWork(type) {
            s.type = type; s.timeLeft = 120;
            save(); updateUI();
        }

        function healWorkers() {
            if (s.med >= 50) {
                s.med -= 50; s.hp = 100; s.shield = 900;
                tg.showAlert("–í—ã–ª–µ—á–µ–Ω–æ! –©–∏—Ç –Ω–∞ 15 –º–∏–Ω.");
                save(); updateUI();
            } else { tg.showAlert("–ú–∞–ª–æ –º–µ–¥–∏—Ü–∏–Ω—ã (–Ω—É–∂–Ω–æ 50)!"); }
        }

        function upgradeHero() {
            if (s.artP >= 5) { s.artP -= 5; s.power += 5; save(); updateUI(); }
            else { tg.showAlert("–ù—É–∂–Ω–æ 5 ‚ú® –ì–µ—Ä–æ—è!"); }
        }

        function doBattle() {
            let mPower = Math.floor(Math.random() * s.power) + 5;
            let log = document.getElementById('battle-log');
            if (s.power >= mPower) {
                let reward = mPower * 3; s.money += reward;
                log.innerHTML = `<p style="color:var(--green)">–ü–æ–±–µ–¥–∞! +${reward}üí∞</p>` + log.innerHTML;
            } else {
                log.innerHTML = `<p style="color:var(--red)">–ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –í—Ä–∞–≥ –±—ã–ª —Å–∏–ª—ë–Ω (${mPower})</p>` + log.innerHTML;
            }
            save(); updateUI();
        }

        function craft(count) {
            if (s.res < count*500 || s.artK < count) return tg.showAlert("–ú–∞–ª–æ —Ä–µ—Å—É—Ä—Å–æ–≤!");
            if (Date.now() < s.forgeReady) return tg.showAlert("–ö—É–∑–Ω—è –æ—Å—Ç—ã–≤–∞–µ—Ç!");
            s.res -= count*500; s.artK -= count;
            for(let i=0; i<count; i++) {
                s.inv.push({ t: Math.random()>0.5?"‚öîÔ∏è":"üõ°Ô∏è", p: Math.floor(Math.random()*50)+s.power });
            }
            s.forgeReady = Date.now() + 180000;
            save(); renderInv(); updateUI();
        }

        setInterval(() => {
            if (s.shield > 0) s.shield--; else s.hp = Math.max(0, s.hp - 0.01);
            
            if(s.type && s.hp > 0) {
                s.timeLeft--;
                if(s.timeLeft <= 0) {
                    s.timeLeft = 120;
                    if(s.type === '–ó–∞–≤–æ–¥') s.res += 45;
                    else if(s.type === '–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è') s.med += 45;
                    else s.food += 45;
                    s.money += 25;
                    if(Math.random()<0.2) s.artK++; if(Math.random()<0.1) s.artP++;
                    save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –≤—ã–ø–ª–∞—Ç—ã
                }
            }
            updateUI();
        }, 1000);

        function updateUI() {
            document.getElementById('m-money').innerText = Math.floor(s.money);
            document.getElementById('m-res').innerText = s.res;
            document.getElementById('m-med').innerText = s.med;
            document.getElementById('m-food').innerText = s.food;
            document.getElementById('m-art-p').innerText = s.artP;
            document.getElementById('m-art-k').innerText = s.artK;
            document.getElementById('p-power').innerText = s.power;
            
            document.getElementById('hp-fill').style.width = s.hp + "%";
            document.getElementById('hp-fill').style.background = s.shield > 0 ? "var(--accent)" : (s.hp < 30 ? "var(--red)" : "var(--green)");
            document.getElementById('shield-info').innerText = s.shield > 0 ? `üõ°Ô∏è –©–ò–¢: ${Math.floor(s.shield/60)}–º` : `HP –†–ê–ë–û–ß–ò–•: ${Math.floor(s.hp)}%`;

            if(s.type) {
                let m = Math.floor(s.timeLeft/60), sc = s.timeLeft%60;
                document.getElementById('timer').innerText = `${m}:${sc < 10 ? '0' : ''}${sc}`;
                document.getElementById('setup-view').style.display = 'none';
                document.getElementById('work-view').style.display = 'block';
                document.getElementById('work-title').innerText = s.type;
                document.getElementById('hp-warning').style.display = s.hp <= 0 ? 'block' : 'none';
            }
        }

        function renderInv() {
            let h = '';
            s.inv.slice().reverse().forEach(i => { h += `<div style="background:#222; padding:8px; margin-top:5px; border-radius:10px; font-size:12px">${i.t} –ú–æ—â–Ω–æ—Å—Ç—å: ${i.p}</div>`; });
            document.getElementById('inv-list').innerHTML = h;
        }

        updateUI(); renderInv();
    </script>
</body>
</html>
