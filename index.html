<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0d0d0d; --card: #1a1a1a; --accent: #3498db; --green: #2ecc71; --red: #e74c3c; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; user-select: none; }
        
        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤ */
        .top-bar { background: var(--card); padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 100; }
        .s-item { font-size: 12px; color: #888; }
        .s-item b { color: #fff; font-size: 16px; display: block; }
        
        .hp-bar { grid-column: span 2; background: #222; height: 10px; border-radius: 5px; overflow: hidden; border: 1px solid #333; }
        #hp-fill { height: 100%; width: 100%; background: var(--green); transition: 1s linear; }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ –º–µ–Ω—é */
        .card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 10px; }
        
        /* –†–µ–¥–∫–æ—Å—Ç—å */
        .rarity-common { border-left: 4px solid #888; color: #888; }
        .rarity-rare { border-left: 4px solid #3498db; color: #3498db; }
        .rarity-epic { border-left: 4px solid #9b59b6; color: #9b59b6; }
        .rarity-mythic { border-left: 4px solid #e74c3c; color: #e74c3c; }
        .rarity-legendary { border-left: 4px solid #f1c40f; color: #f1c40f; text-shadow: 0 0 5px rgba(241,196,15,0.3); }

        .stat-line { color: #2ecc71; font-size: 12px; }
        .enchant-line { color: #f39c12; font-size: 12px; font-style: italic; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .navbar { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; border-top: 1px solid #333; padding: 10px 0; }
        .nav-item { flex: 1; text-align: center; color: #555; font-size: 11px; }
        .active-nav { color: var(--accent); }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="s-item">üí∞ –ú–æ–Ω–µ—Ç—ã <b id="money">100</b></div>
        <div class="s-item">üì¶ –°–∫–ª–∞–¥ <b id="res_count">0</b></div>
        <div class="s-item">üß™ –ú–µ–¥. <b id="med_stock">0</b></div>
        <div class="s-item">‚ú® –ê—Ä—Ç. <b id="arts">0</b></div>
        <div class="hp-bar"><div id="hp-fill"></div></div>
        <div id="shield-stat" style="grid-column: span 2; text-align: center; font-size: 10px; margin-top: 5px;">–°–¢–ê–¢–£–°: –£–Ø–ó–í–ò–ú</div>
    </div>

    <div id="page-main" class="page active">
        <div id="choice-screen">
            <h3>üè¢ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é</h3>
            <button class="btn" onclick="startWork('med')">üè• –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è (–ú–µ–¥)</button>
            <button class="btn" onclick="startWork('build')" style="margin-top:10px">üß± –ó–∞–≤–æ–¥ (–ö–∏—Ä–ø–∏—á–∏)</button>
            <button class="btn" onclick="startWork('food')" style="margin-top:10px">üçé –¢–µ–ø–ª–∏—Ü–∞ (–ï–¥–∞)</button>
        </div>
        <div id="work-ui" style="display:none; text-align: center;">
            <h2 id="ind-title">–û–±—ä–µ–∫—Ç</h2>
            <div style="font-size: 30px; margin: 20px 0;" id="timer">--:--</div>
            <button class="btn" style="background:var(--green)" onclick="useMed()">üíâ –ó–∞—â–∏—Ç–∞ –∑–∞ 100 –ú–µ–¥.</button>
            <button class="btn" style="background:#222" onclick="save()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>
    </div>

    <div id="page-forge" class="page">
        <h3>üî® –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∞—è –ö—É–∑–Ω–∏—Ü–∞</h3>
        <div class="card">
            <b>–ö–æ–≤–∫–∞ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è</b><br>
            <small>–¶–µ–Ω–∞: 500üì¶ + 1‚ú®</small>
            <button class="btn" onclick="craftItem()">–ö–û–í–ê–¢–¨</button>
        </div>
        <div id="inventory-list"></div>
    </div>

    <nav class="navbar">
        <div class="nav-item active-nav" onclick="showPage('main')">üè¢ –û–±—ä–µ–∫—Ç</div>
        <div class="nav-item" onclick="showPage('forge')">üî® –ö—É–∑–Ω–∏—Ü–∞</div>
    </nav>

    <script>
        let tg = window.Telegram.WebApp;
        let s = { money: 100, res: 0, med: 0, arts: 0, hp: 100, shield: 0, type: '', timeLeft: 0, inv: [] };

        const rarities = [
            { n: '–û–±—ã—á–Ω—ã–π', c: 60, cls: 'rarity-common', m: 1 },
            { n: '–†–µ–¥–∫–∏–π', c: 25, cls: 'rarity-rare', m: 1.5 },
            { n: '–≠–ø–∏—á–µ—Å–∫–∏–π', c: 10, cls: 'rarity-epic', m: 2.2 },
            { n: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π', c: 4, cls: 'rarity-mythic', m: 3.5 },
            { n: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π', c: 1, cls: 'rarity-legendary', m: 5 }
        ];

        const enchants = {
            w: ["üî• –í–æ—Å–ø–ª–∞–º–µ–Ω–µ–Ω–∏–µ", "‚ö° –°–∫–æ—Ä–æ—Å—Ç—å", "üéØ –ö—Ä–∏—Ç. —à–∞–Ω—Å", "üíÄ –ö—Ä–∏—Ç. —É—Ä–æ–Ω"],
            a: ["üíé –û—Ç—Ä–∞–∂–µ–Ω–∏–µ", "üåµ –®–∏–ø—ã", "üèÉ –£–≤–æ—Ä–æ—Ç", "üõ°Ô∏è –ó–∞—â–∏—Ç–∞"]
        };

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
            event.currentTarget.classList.add('active-nav');
        }

        function startWork(t) {
            s.type = t; s.timeLeft = Math.floor(Math.random() * 300) + 300;
            document.getElementById('choice-screen').style.display = 'none';
            document.getElementById('work-ui').style.display = 'block';
            document.getElementById('ind-title').innerText = t.toUpperCase();
        }

        function craftItem() {
            if(s.res < 500 || s.arts < 1) return tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤!");
            s.res -= 500; s.arts -= 1;

            let r = rarities[0]; let rd = Math.random() * 100; let acc = 0;
            for(let x of rarities) { acc += x.c; if(rd <= acc) { r = x; break; } }

            let q = 1 + (Math.random() * 10) / 100; // –†–∞–Ω–¥–æ–º 1-10%
            let power = r.m * q;
            let isW = Math.random() > 0.5;
            let item = {
                id: Date.now(), name: isW ? "–ú–µ—á" : "–ë—Ä–æ–Ω—è",
                rar: r.n, cls: r.cls, qual: Math.round((q-1)*100),
                stats: isW ? [`–£—Ä–æ–Ω: ${Math.round(20*power)}`] : [`–•–ü: ${Math.round(100*power)}`],
                ench: []
            };

            let eCount = r.n === '–†–µ–¥–∫–∏–π' ? 1 : r.n === '–≠–ø–∏—á–µ—Å–∫–∏–π' ? 2 : r.n === '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π' ? 3 : r.n === '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' ? 4 : 0;
            let p = [...enchants[isW ? 'w' : 'a']];
            for(let i=0; i<eCount; i++) if(p.length) item.ench.append(p.splice(Math.floor(Math.random()*p.length), 1)[0]);

            s.inv.push(item);
            updateInvUI();
            updateUI();
        }

        function updateInvUI() {
            let html = '';
            s.inv.forEach(i => {
                html += `<div class="card ${i.cls}"><b>${i.rar} ${i.name}</b> (+${i.qual}%)<br>`;
                i.stats.forEach(st => html += `<div class="stat-line">${st}</div>`);
                i.ench.forEach(en => html += `<div class="enchant-line">‚ú® ${en}</div>`);
                html += `</div>`;
            });
            document.getElementById('inventory-list').innerHTML = html;
        }

        function useMed() {
            if(s.med >= 100) { s.med -= 100; s.shield = 900; s.hp = 100; tg.showAlert("–ó–∞—â–∏—Ç–∞ –Ω–∞ 15–º!"); }
            updateUI();
        }

        setInterval(() => {
            if(!s.type) return;
            s.timeLeft--;
            if(s.timeLeft <= 0) {
                s.timeLeft = Math.floor(Math.random() * 300) + 3
