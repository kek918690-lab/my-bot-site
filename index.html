<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0d0d0d; --card: #1a1a1a; --accent: #3498db; --green: #2ecc71; --red: #e74c3c; --text: #ffffff; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        
        .top-bar { background: var(--card); padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; border-bottom: 2px solid #333; position: sticky; top: 0; z-index: 100; }
        .res-item { font-size: 11px; color: #888; }
        .res-item b { color: #fff; font-size: 15px; display: block; }
        .hp-container { grid-column: span 2; background: #222; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1px solid #333; }
        #hp-fill { height: 100%; width: 100%; background: var(--green); transition: 0.5s; }

        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #333; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
        
        .navbar { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; border-top: 1px solid #333; padding: 10px 0; }
        .nav-item { flex: 1; text-align: center; color: #555; font-size: 10px; cursor: pointer; }
        .active-nav { color: var(--accent); }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="res-item">üí∞ –ú–æ–Ω–µ—Ç—ã <b id="m-money">0</b></div>
        <div class="res-item">üß± –†–µ—Å—É—Ä—Å—ã <b id="m-res">0</b></div>
        <div class="res-item">üß™ –ú–µ–¥–∏—Ü–∏–Ω–∞ <b id="m-med">0</b></div>
        <div class="res-item">‚ú® –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã <b id="m-arts">0</b></div>
        <div class="hp-container"><div id="hp-fill"></div></div>
        <div id="shield-text" style="grid-column: span 2; text-align: center; font-size: 10px; margin-top: 4px;">–°–¢–ê–¢–£–°...</div>
    </div>

    <div id="p-hire" class="page"><h3>üë• –ù–∞–π–º</h3><div class="card">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</div></div>
    
    <div id="p-obj" class="page active">
        <div id="setup-view">
            <h3>üè¢ –í—ã–±–æ—Ä –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</h3>
            <button class="btn" onclick="startWork('build')">üß± –ö–∏—Ä–ø–∏—á–Ω—ã–π –∑–∞–≤–æ–¥</button>
            <button class="btn" onclick="startWork('med')" style="margin-top:10px; background:var(--green)">üß™ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –º–µ–¥–∏—Ü–∏–Ω—ã</button>
        </div>
        <div id="work-view" style="display:none; text-align: center;">
            <h2 id="work-title">–†–ê–ë–û–¢–ê</h2>
            <div id="timer" style="font-size: 40px; font-weight: bold; margin: 20px 0; color: var(--accent);">--:--</div>
            <button class="btn" style="background:var(--green)" onclick="applyMed()">üíâ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 100 –ú–µ–¥.</button>
        </div>
    </div>

    <div id="p-market" class="page"><h3>‚öñÔ∏è –†—ã–Ω–æ–∫</h3><div class="card">–ö—É–∑–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–º –∏–≥—Ä–æ–∫–∞–º.</div></div>
    
    <div id="p-settings" class="page">
        <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="card" id="offline-report" style="font-size: 12px; color: var(--gold); display: none;"></div>
        <button class="btn" onclick="saveData()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ü–†–û–ì–†–ï–°–°</button>
    </div>

    <nav class="navbar">
        <div class="nav-item" onclick="tab('hire')">üë• –ù–∞–π–º</div>
        <div class="nav-item active-nav" onclick="tab('obj')">üè¢ –û–±—ä–µ–∫—Ç</div>
        <div class="nav-item" onclick="tab('market')">‚öñÔ∏è –†—ã–Ω–æ–∫</div>
        <div class="nav-item" onclick="tab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä.</div>
    </nav>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        let s = { 
            money: 100, res: 0, med: 0, arts: 0, 
            hp: 100, shield: 0, type: '', timeLeft: 0, 
            lastTime: Date.now() 
        };

        function tab(name) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('p-' + name).classList.add('active');
        }

        function startWork(type) {
            s.type = type;
            s.timeLeft = Math.floor(Math.random() * 301) + 300;
            document.getElementById('setup-view').style.display = 'none';
            document.getElementById('work-view').style.display = 'block';
            document.getElementById('work-title').innerText = type === 'build' ? 'üß± –ó–ê–í–û–î' : 'üß™ –õ–ê–ë–û–†–ê–¢–û–†–ò–Ø';
        }

        // --- –õ–û–ì–ò–ö–ê –ê–§–ö (–ë–ï–ó –ê–†–¢–ï–§–ê–ö–¢–û–í) ---
        function calculateOffline() {
            let now = Date.now();
            let diff = Math.floor((now - (s.lastTime || now)) / 1000);
            
            if (diff > 60 && s.type !== '') {
                let cycles = Math.floor(diff / 450); // –°—Ä–µ–¥–Ω–∏–π —Ü–∏–∫–ª 7.5 –º–∏–Ω
                
                if (cycles > 0) {
                    if (s.type === 'build') s.res += cycles * 15;
                    else if (s.type === 'med') s.med += cycles * 15;
                    s.money += cycles * 5;

                    let report = document.getElementById('offline-report');
                    report.style.display = 'block';
                    report.innerHTML = `
                        <b>üìä –ê–§–ö –∑–∞ ${Math.floor(diff/60)} –º–∏–Ω:</b><br>
                        üì¶ –†–µ—Å—É—Ä—Å—ã: +${cycles * 15}<br>
                        üí∞ –ú–æ–Ω–µ—Ç—ã: +${cycles * 5}<br>
                        <span style="color:var(--red)">‚ú® –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤ –ê–§–ö –Ω–µ –≤—ã–ø–∞–¥–∞—é—Ç!</span>
                    `;
                }

                // –†–∞—Å—á–µ—Ç —â–∏—Ç–∞ –∏ –•–ü
                if (s.shield > 0) {
                    s.shield -= diff;
                    if (s.shield < 0) {
                        let unprot = Math.abs(s.shield) / 60;
                        s.hp -= unprot * 1;
                        s.shield = 0;
                    }
                } else {
                    s.hp -= (diff / 60) * 1;
                }
                if (s.hp < 0) s.hp = 0;
            }
            s.lastTime = now;
            updateUI();
        }

        function applyMed() {
            if(s.med >= 100) { s.med -= 100; s.shield += 900; s.hp = 100; }
            updateUI();
        }

        function saveData() {
            s.lastTime = Date.now();
            tg.sendData(JSON.stringify(s));
            tg.showAlert("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        }

        // –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ (–û–ù–õ–ê–ô–ù)
        setInterval(() => {
            if(s.type !== '') {
                s.timeLeft--;
                if(s.timeLeft <= 0) {
                    s.timeLeft = Math.floor(Math.random() * 301) + 300;
                    if(s.type === 'build') s.res += 15; else s.med += 15;
                    s.money += 5;
                    // –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤—ã–ø–∞–¥–∞—é—Ç –¢–û–õ–¨–ö–û –¢–£–¢ (–≤ –æ–Ω–ª–∞–π–Ω–µ)
                    if(Math.random() < 0.15) {
                        s.arts++;
                        tg.showAlert("‚ú® –ù–∞–π–¥–µ–Ω —Ä–µ–¥–∫–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç!");
                    }
                }
            }
            if(s.shield > 0) s.shield--; else s.hp -= (1/60);
            if(s.hp < 0) s.hp = 0;
            s.lastTime = Date.now();
            updateUI();
        }, 1000);

        function updateUI() {
            document.getElementById('m-money').innerText = Math.floor(s.money);
            document.getElementById('m-res').innerText = s.res;
            document.getElementById('m-med').innerText = s.med;
            document.getElementById('m-arts').innerText = s.arts;
            document.getElementById('hp-fill').style.width = s.hp + "%";
            
            let st = document.getElementById('shield-text');
            if(s.shield > 0) {
                st.innerText = `–ó–ê–©–ò–¢–ê: ${Math.floor(s.shield/60)}–º`;
                st.style.color = "var(--accent)";
            } else {
                st.innerText = "–£–Ø–ó–í–ò–ú (–•–ü -1%/–º–∏–Ω)";
                st.style.color = "var(--red)";
            }

            if(s.type) {
                let m = Math.floor(s.timeLeft/60), sc = s.timeLeft%60;
                document.getElementById('timer').innerText = `${m}:${sc < 10 ? '0' : ''}${sc}`;
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ
        setTimeout(calculateOffline, 500);
    </script>
</body>
</html>
